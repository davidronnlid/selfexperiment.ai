# User Unit Preference System

## Overview

Users can now select different units for variables than their current preferred one, which will update the `display_unit` column in the `user_variable_preferences` table. The system implements a priority-based approach where user preferences override default variable units.

## Priority System

The unit preference system follows this hierarchy (highest to lowest priority):

1. **User Preferences** (Priority: -1)
   - Stored in `user_variable_preferences.display_unit` as JSONB
   - Format: `{"unit_id": "unit_name", "unit_group": "group_name"}`
   - **Always takes precedence** over variable_units priorities

2. **Variable Units** (Priority: 1, 2, 3, ...)
   - Stored in `variable_units` table with `priority` column
   - Lower numbers = higher priority (1 is highest priority in variable_units)
   - Used as fallback when user has no preference

## Database Schema

### user_variable_preferences Table
```sql
CREATE TABLE user_variable_preferences (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    variable_id UUID NOT NULL REFERENCES variables(id) ON DELETE CASCADE,
    display_unit JSONB, -- {"unit_id": "kg", "unit_group": "mass"}
    is_shared BOOLEAN DEFAULT false,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(user_id, variable_id)
);
```

### variable_units Table
```sql
CREATE TABLE variable_units (
    variable_id UUID REFERENCES variables(id) ON DELETE CASCADE,
    unit_id TEXT REFERENCES units(id) ON DELETE CASCADE,
    priority INTEGER NOT NULL DEFAULT 1,
    note TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    PRIMARY KEY (variable_id, unit_id)
);
```

## Database Functions

### set_user_unit_preference(user_id, variable_id, unit_id, unit_group)
- Sets or updates user's preferred unit for a variable
- Validates that the unit is valid for the variable
- Stores preference as JSONB in `display_unit` column
- Returns TRUE on success, FALSE on failure

### get_user_preferred_unit(user_id, variable_id)
- Returns user's preferred unit if exists (priority -1)
- Falls back to highest priority unit from variable_units table
- Returns: unit_id, label, symbol, unit_group, is_base, priority, is_user_preference

### get_variable_units(variable_id)
- Returns all available units for a variable
- Ordered by priority (lower numbers = higher priority)
- Returns: unit_id, label, symbol, unit_group, is_base, is_default_group, priority

## Frontend Components

### VariableUnitSelector
**Location:** `src/components/VariableUnitSelector.tsx`

**Purpose:** Allows users to select their default unit preference for a variable

**Features:**
- Displays available units grouped by type
- Shows user's current preference
- Automatically saves selections to database
- Used in variable pages and settings

**Usage:**
```jsx
<VariableUnitSelector
  variableId={variableId}
  userId={userId}
  currentUnit={displayUnit}
  onUnitChange={async (unitId, unitGroup) => {
    await updateDisplayUnit(unitId, unitGroup);
    await refetchDisplayUnit();
  }}
  label="Your Default Unit"
/>
```

### ManualUnitSelector
**Location:** `src/components/ManualUnitSelector.tsx`

**Purpose:** Advanced unit selector for manual tracking with option to set new defaults

**Features:**
- Displays current default unit vs selected unit
- "Set as Your New Default Unit" checkbox
- Visual indicators for default units
- Integrated with manual tracking workflow

**Usage:**
```jsx
<ManualUnitSelector
  variableId={variableId}
  userId={userId}
  currentDisplayUnit={userDefaultUnit}
  selectedUnit={currentlySelectedUnit}
  onUnitChange={(unitId) => setSelectedUnit(unitId)}
  onDefaultUnitChange={async (unitId, unitGroup) => {
    // Update user's default preference
    await saveUserUnitPreference(unitId, unitGroup);
  }}
/>
```

## Implementation Details

### Priority Logic
1. When getting a user's preferred unit:
   - Check `user_variable_preferences.display_unit` first
   - If found, return that unit with priority -1
   - Otherwise, return highest priority unit from `variable_units` table

2. When setting a user preference:
   - Validate unit is available for the variable
   - Store as JSONB: `{"unit_id": "kg", "unit_group": "mass"}`
   - Update or insert into `user_variable_preferences`

### Frontend Flow
1. **Load available units:** Call `get_variable_units(variable_id)`
2. **Load user preference:** Call `get_user_preferred_unit(user_id, variable_id)`
3. **User selects new unit:** Call `set_user_unit_preference(user_id, variable_id, unit_id, unit_group)`
4. **Update UI:** Refresh components to show new preference

## Migration Applied

**File:** `supabase/migrations/20250128000003_fix_user_unit_preferences_unified.sql`

**Changes:**
- Unified database functions for consistent behavior
- Fixed JSONB storage format for display_unit
- Implemented proper priority system
- Added validation and error handling
- Created comprehensive test queries

## Key Benefits

1. **User Control:** Users can override default units with their preferences
2. **Consistency:** Unified database functions ensure reliable behavior  
3. **Flexibility:** Supports multiple unit groups per variable
4. **Performance:** User preferences cached and prioritized correctly
5. **Validation:** Ensures selected units are valid for variables

## Example Workflow

1. User visits a variable page (e.g., "Broccoli")
2. System shows current default unit (e.g., "grams") 
3. User opens unit selector and chooses "cups"
4. System calls `set_user_unit_preference()` to save choice
5. User's preference is now stored with priority -1 (highest)
6. All future interactions use "cups" as the default unit
7. User can change back anytime or choose different units for individual logs

## Testing

To test the system:
1. Apply the migration: `supabase/migrations/20250128000003_fix_user_unit_preferences_unified.sql`
2. Use the VariableUnitSelector component on any variable page
3. Select a different unit and verify it saves
4. Refresh the page and confirm the new unit is selected
5. Use ManualUnitSelector for advanced unit selection with default setting